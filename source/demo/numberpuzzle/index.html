<html>

<head>

<style>
.cel {
	width: 30px;
	height: 30px;
	margin: 5px;
	text-align: center;
	vertical-align: middle;
	background-color: yellow;
	font-family: monospace;
	font-size: medium;
	position: absolute;
}
.heading {
	font-size:large;
	font-weight:bold;
	margin-top:15px;
}
</style>

<script>

//GLOBAL VARIABLES
var grid_width;
var grid_height;
var empty;
var moves = 0;

//FUNCTIONS
function drawGrid (rows,cols, target) {
	//creates each cel, sends it to calcPosition
	//to change the cel's location
	//then adds it to a div in the page so it displays
	var cel_num = 1;//will be the id and content of cell
	var total_cells = rows*cols;
	for (i=0;i<rows;i++) {
		for (j=0;j<cols;j++) {
			//create each cel and add to grid
			var cel_obj = document.createElement("div");
			if (cel_num != total_cells) {
				//leave the last cel blank
				//otherwise create a number
				//and add it to the cel
				var cel_content = document.createTextNode(cel_num);
				cel_obj.appendChild(cel_content);
			}
			cel_obj.setAttribute("id",cel_num);//so contents can be modified
			cel_obj.setAttribute("class", "cel");//so css attributes can be used to determine position down below
			cel_obj.setAttribute("onClick","swap("+cel_num+")\;");//so stuff happens when the cell is clicked on

			//add the cel (and its contents) to the page
			document.getElementById(target).appendChild(cel_obj);

			//move the cel to the right position
			calcPosition (cel_num, i, j);

			//get ready for the next one
			cel_num++;
		}
	}

	//modify the global variables based on the new grid size
	grid_width = cols;
	grid_height = rows;
	empty = cols * rows;

	moveControls();
}

function calcPosition (id, row, column) {
	//calculates the position of each cel on the grid
	//based on which cell it is and the size of each cel
	//modifies the absolute position of the cel
	//using css
	var size_array = getSizes(id);
	var margin_top = size_array[0];
	var margin_left = size_array[1];
	var height = size_array[2];
	var width = size_array[3];

	//determine top and left position of cel
	var top = (margin_top * (row + 1)) + (height * row);
	var left = (margin_left * (column + 1)) + (width * column);

	//actually change the cel's position
	//(way easier to set than get, no?)
	var cel_obj = document.getElementById(id);
	cel_obj.style.top = top;
	cel_obj.style.left = left;
}

function getSizes (id) {
	var cel_obj = document.getElementById(id);

	if (cel_obj.currentStyle) {
		//IE version of getting position info
		var margin_top = stripPX(cel_obj.currentStyle[margin-top]);
		var margin_left = stripPX(cel_obj.currentStyle[margin-left]);
		var height = stripPX(cel_obj.currentStyle[height]);
		var width = stripPX(cel_obj.currentStyle[width]);
	}
	else if (window.getComputedStyle) {
		//Firefox version of getting position info
		var margin_top = stripPX(document.defaultView.getComputedStyle(cel_obj,null).getPropertyValue("margin-top"));
		var margin_left = stripPX(document.defaultView.getComputedStyle(cel_obj,null).getPropertyValue("margin-left"));
		var height = stripPX(document.defaultView.getComputedStyle(cel_obj,null).getPropertyValue("height"));
		var width = stripPX(document.defaultView.getComputedStyle(cel_obj,null).getPropertyValue("width"));
	}
	else {
		//Safari doesn't give position info, apparently
		return false; //so it doesn't keep going with nonexistent variables
	}
	return new Array (margin_top,margin_left,height,width);
}

function stripPX (number) {
	//css sizes require units, e.g. px
	//removes the unit from the end of the number
	//e.g. 5px -->5
	//will not work if the unit is not 2 letter
	//or if there is a space between number and unit
	//I could get it to work for that with regular expressiosn
	return parseInt(number.substring(0,number.length-2));
}

function moveControls () {
	//move the controls (grid size box, etc. below the grid
	//get the styles for the cel class
	var cel_styles = document.styleSheets[0].cssRules[0].style;
	var margin_top = stripPX(cel_styles.marginTop);
	var height = stripPX(cel_styles.height);
	var top = (margin_top * (grid_height + 1)) + (height * grid_height) + 10;
	//get the control div
	control_obj = document.getElementById("controls");
	//change the position of the control div
	control_obj.style.top = top;
}

function redraw  (value, target) {
	//activated when the user selects a grid size
	//from the select box
	clear(target);
	drawGrid(value,value,target);
}

function clear (target) {
	//removes all current cells from the grid
	//so it can be redrawn
	var target_obj = document.getElementById(target);
	while (target_obj.hasChildNodes()) {
		target_obj.removeChild(target_obj.firstChild);
	}
}

function randomizeGrid (target) {
	var used_vals = new Array();
	for (i=1;i<=grid_height*grid_width;i++) {
		//get a number to put in each cel
		var usedvals_and_value = getUniqueNum(used_vals);
		//get used_vals and value out
		//of the array returned by getUniqueNum
		used_vals = usedvals_and_value[0];
		var value = usedvals_and_value[1];
		//put the number in the cell
		replace(i,value);
	}
	moves = 0;
	updateMoves();
}

function getUniqueNum (used_vals) {
		//get a number to put in the cel
		//must not be in any previous cel
		//previously used numbers are in used_vals array
		var need_new_num = true;
		while(need_new_num == true) {
			var found = false;
			value = (Math.round((Math.random()*((grid_width*grid_height)-1))+1));
			for (k=0;k<used_vals.length;k++) {
				if (value == used_vals[k]) {
					//the number has already been used
					//must get a new one
					found = true;
					break;
				}
			}
			if (!found) {
				//the number is not already in a cel
				used_vals[used_vals.length] = value;
				need_new_num = false;
			}
		}
		//both used_vals array and value modified
		//need to return both
		//can only return as array
		return new Array (used_vals, value);
}

function resetGrid (target) {
	//resets the grid in numerical order
	//without redrawing or changing size
	for (i=1;i<=grid_width*grid_height;i++)
		replace(i,i);
	empty = grid_width * grid_height;

	moves = 0;
	updateMoves();
}

function swap(cel) {
	//moves the contents of the cell selected
	//into the empty cell
	//if they are adjacent
	if(verify(cel)) {
		var cel_obj = document.getElementById(cel);
		var empty_obj = document.getElementById(empty);

		while (cel_obj.hasChildNodes())
			empty_obj.appendChild(cel_obj.firstChild);

		empty = cel;

		moves++;
		updateMoves();
		if(checkWin()) alert('You win!\nMoves: ' + moves);
	}
}

function verify(cel) {
	//verifies that the selected cell
	//and the empty cell are adjacent
	if ((empty == (cel - grid_width)) ||
		(empty == (cel + grid_width)) ||
		(empty == (cel - 1)) ||
		(empty == (cel + 1)))
		return true;
	else 
		return false;
}

function replace (cel, value) {
	//replaces the contents of one cell with
	//a new value or leaves it empty if the value
	//is the highest possible for the grid size
	var cel_obj = document.getElementById(cel);
	while(cel_obj.hasChildNodes())
		cel_obj.removeChild(cel_obj.firstChild);
	if (value != grid_width * grid_height) {
		content = document.createTextNode(value);
		cel_obj.appendChild(content);
	}
	else empty = cel;
}

function changeCelSize (size) {
	if (size == "small") {
		var margin = 5;
		var width = 30;
		var fontsize = 'medium';
	}
	else if (size == "medium") {
		var margin = 8;
		var width = 45;
		var fontsize = 'large';
	}
	else if (size =="large") {
		var margin = 10;
		var width = 60;
		var fontsize = 'x-large';
	}
	var cel_styles = document.styleSheets[0].cssRules[0].style;
	cel_styles.width = width;
	cel_styles.height = width;
	cel_styles.margin = margin;
	cel_styles.fontSize = fontsize;

	var cel_num = 1;
	for (i=0;i<grid_height;i++) {
		for (j=0;j<grid_width;j++) {
			calcPosition (cel_num, i, j);
			cel_num++;
		}
	}
	moveControls();
}

function changeCelColor (color) {
	var cel_styles = document.styleSheets[0].cssRules[0].style;
	cel_styles.backgroundColor = color;
}

function checkWin() {
	for(i=1;i<=grid_height*grid_width;i++) {
		var cel_obj = document.getElementById(i);
		if(cel_obj.hasChildNodes())
			if(cel_obj.firstChild.nodeValue!=i) return false;
	}
	return true;
}

function updateMoves() {
	moves_obj = document.getElementById('moves');
	while(moves_obj.hasChildNodes())
		moves_obj.removeChild(moves_obj.firstChild);
	content = document.createTextNode(moves);
	moves_obj.appendChild(content);
}

</script>

</head>

<body onLoad="drawGrid(5,5,'grid');updateMoves();">

	<div id="grid">

	</div>
	<div id="controls" style="position:absolute;">
	   <form>
			<select id="grid_size">
				<option value="" selected="true">--Change Grid Size--</option>
				<option value="3" onClick="redraw(3,'grid');">3 by 3</option>
				<option value="4" onClick="redraw(4,'grid');">4 by 4</option>
				<option value="5" onClick="redraw(5,'grid');">5 by 5</option>
				<option value="6" onClick="redraw(6,'grid');">6 by 6</option>
			</select>
		</form>
		<a href="#" onClick="randomizeGrid('grid');">Randomize</a><br/>
		<a href="#" onClick="resetGrid('grid');">Reset</a>
		<div class="heading">Style</div>
		<form>
			<select id="cel_size">
				<option value="" selected="true">--Cel Size--</option>
				<option value="small" onClick="changeCelSize('small');">Small</option>
				<option value="medium" onClick="changeCelSize('medium');">Medium</option>
				<option value="large" onClick="changeCelSize('large');">Large</option>
			</select><br/>
			<select id="cel_color">
				<option value="" selected="true">--Cel Color--</option>
				<option value="yellow" onClick="changeCelColor('yellow');">Yellow</option>
				<option value="cyan" onClick="changeCelColor('cyan');">Cyan</option>
				<option value="pink" onClick="changeCelColor('pink');">Pink</option>
			</select>
		</form>
		<span class="heading">Moves:</span> <span id="moves"></span>
	</div>

</body>

</html>
